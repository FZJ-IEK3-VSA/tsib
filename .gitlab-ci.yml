# for further structuring check https://docs.gitlab.com/ee/ci/yaml/

variables:
  # Clone rather than fetch so we have a completely clean workspace without
  # any previous temporary_branch left over from past CI runs.
  GIT_STRATEGY: clone
  temporary_branch: "gitlab-ci-ipynb2py"
  GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no -i .ssh/id_rsa-gitlab-ci"
  # ssh_deploy_key is defined under Settings > CI/CD Pipelines > Secret Variables.

enerx:
  stage: test
  image: everken/enerx:python3.7-cbc2.9
  script:
    - export SOLVER="cbc"
    - pip install -e .
    - pytest --cov=tsib/ test/

# Push autogenerated Python scripts from Jupyter notebooks back to the repository
ipynb2py:
  stage: build
  rules:
    # Only run in a specific project path (dont use it in forks)
    # If you want to use it in forks you have to set up your own ssh deploy key pair for the fork
    - if: '$CI_PROJECT_PATH == "iek-3/groups/urban-energy-systems/urbanmodels/tsib"'
      # Only run for changes in the examples folder and subdirectories
      changes:
        - examples/**.ipynb
  image: python:3.7-alpine
  before_script:
    - apk update && apk upgrade && apk add --no-cache bash git openssh perl
    # Install Jupytext
    - pip install --no-cache-dir jupytext
  script:
    # Prepare git for pushing back to repository.
    - mkdir -pvm 0700 .ssh
    - echo "$ssh_deploy_key" > .ssh/id_rsa-gitlab-ci
    - chmod 0400 .ssh/id_rsa-gitlab-ci
    - git checkout -b "$temporary_branch"
    - git config --global user.email $(git --no-pager show -s --format='%ae' HEAD)
    - git config --global user.name $(git --no-pager show -s --format='%an' HEAD)
    - echo $(/bin/bash -c 'perl -pe "s#.*@(.+?(\:\d+)?)/#git@\1:#" <<< $CI_REPOSITORY_URL')
    - git remote set-url --push origin $(/bin/bash -c 'perl -pe "s#.*@(.+?(\:\d+)?)/#git@\1:#" <<< $CI_REPOSITORY_URL')
    # Create Python scripts from Jupyter notebooks
    - cd examples
    - find * -name '*.ipynb' -exec jupytext --to py:percent {} \;
    - cd ..
    # Push updated notebooks back to repository. (Always return true even
    # if there are no changes to commit and push).
    - git add examples
    - git commit -m "Autogenerated py from ipynb for $CI_COMMIT_SHA [skip ci]" || true
    - git push origin "$temporary_branch:$CI_COMMIT_REF_NAME" || true
  after_script:
    # Remove ssh folder
    - rm -Rfv .ssh
